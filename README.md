#### Учебный проект

от Karpov.Courses [Karpov.Courses](https://karpov.courses/simulator)

# Анализ A/B теста нового алгоритма рекомендации постов

## Цель проекта  

 Оценить эффективность нового алгоритма рекомендации постов, проверив гипотезу о его положительном влиянии   
 на **CTR (Click-Through Rate)** в ходе A/B-теста, и принять взвешенное решение о его запуске для всех новых пользователей.

## Задачи  

 - Провести первичный анализ данных: загрузить данные, проверить их целостность и корректность разделения на группы.
   
 - Исследовать распределения: визуально и статистически оценить распределение показов, кликов и CTR в обеих группах.
   
 - Применить комплекс статистических тестов:
   - **T-тест на исходных данных**;
     
   - **Тест Манна-Уитни на исходных данных**;
     
   - **Пуассоновский бутстреп**;
     
   - **Т-тест на сглаженном CTR (с α=5)**;
     
   - **Т-тест и тест Манна-Уитни на данных, агрегированных по бакетам**;
     
   - **T-тест и тест Манна-Уитни на бакетных данных (90-й перцентиль)**.

  - Интерпретировать результаты: объяснить возможные расхождения между результатами разных тестов, опираясь на природу данных.

  - Сформулировать вывод и рекомендацию: на основе совокупности доказательств дать обоснованную рекомендацию о раскатке нового алгоритма.

## Инструменты

  - **База данных**: ClickHouse  
  - **Язык программирования:** Python
  - **Основные библиотеки:** pandas, numpy, scipy, statsmodels, matplotlib/seaborn
  - **Методы:** Статистическое тестирование, бутстреп, визуализация данных
  
## Источники информации  

  - База данных в ClickHouse.

#### Структура таблиц БД

**1. Feed_actions**
 - **post_id:** id поста;
 - **user_id:** id пользователя;
 - **action:** совершенное действие view/like;
 - **time:** время совершенного действия;
 - **gender/city/country/os/source:** информация о пользователе;
 - **exp_group:** номер эксперементальной группы.

**2. Message_actions**
- **user_id:** id отправителя сообщения;
- **receiver_id:** id получателя сообщения;
- **time:** время совершенного действия;
- **gender/city/country/os/source:** информация о пользователе.

## Структура проекта

 - `AB_project_final.ipynb` - полный цикл анализа A/B теста.
   
## Вводные данные А/Б теста

 **1. Данные для теста**  
 
  - Эксперимент проходил с 2025-08-02 по 2025-08-08 включительно;
  - Для эксперимента были задействованы 2 и 1 группы;
  - В группе 2 был использован один из новых алгоритмов рекомендации постов.
 
**2. Группы:**

 - **1 группа** - контрольная (без изменений);
 - **2 группа** - тестовая (был использован один из новых алгоритмов рекомендации постов).

 **3. Основная метрика:**

  - **CTR**

**4. Гипотезы**

- **Нулевая гипотеза:** Новый алгоритм не приведет к увелечению CTR во 2ой группе.
- **Альтернативная гипотеза:** Новый алгоритм во 2-й группе приведет к увеличению CTR. 

## Этапы решения

### 1. Распределение по группам.

 **1.1. Количество участников**
 
![Распределение по группам](https://github.com/Alexa-grab/screenshots--for--projects./blob/main/%D0%A0%D0%B0%D1%81%D0%BF%D1%80%D0%B5%D0%B4%D0%B5%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%BF%D0%BE%20%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D0%B0%D0%BC.png)

  **Выводы**
 
   - Количество участников распределено равномерно;
   - В каждой группе ~ 10000 человек.
 
  **1.2. Анализ равномерности распределения и значения метрики CTR**
 
![Распределение CTR для группы 1 и 2](https://github.com/Alexa-grab/screenshots--for--projects./blob/main/%D1%80%D0%B0%D1%81%D0%BF%D1%80%D0%B5%D0%B4%D0%B5%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20CTR%20%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D1%8B%201%20%D0%B8%202.png)

 **Выводы**

  - **Гистограммы распределения CTR**
    
    - В 2 группе (тестовой), правый хвост длиннее, чем в 1 группе.
    - Большинство значений во 2 группе < значений 1 группы.
     
  Распределения CTR в группах имеют разную форму: во второй группе присутствует длинный правый хвост при том, что основная масса значений ниже, чем в первой.

 - **Среднее значение CTR в группах**
  
   - AVG CTR гр.1 =0.216773994120072
   - AVG CTR гр.2 =0.2161016893237817
   - Разница diff= -0.0006723047962902962
     
 **CTR 1 группы (контрольной) > CTR 2 группы (тестовой)**

### 2. Проведение Т-теста

 **Выводы**

 - **t_stat** = 0.4051491913112757;
 - **p_val** = 0.685373331140751;
 - Т-тест менее чувствителен к данным, т.к. разница между средними группами очень маленькая (в абсолютном значении -0.00067).
   
**Различия между группами статистически незначимы.**

### 3. Тест Манна-Уитни

 **Выводы**

 - **y_stat** = 55189913.00 
 - **y_pval** = 4.632205841806026e-45
 - Тест показал значимые отличия, т.к. он  чувствителен к форме распределения (во 2-й группе длинный правый хвост,
что  создает разницу в распределениях)

**Различия есть, нулевая гипотеза не верна**

### 4. Метод Пуассоновский бутстреп

 **Код для создании функции bootstrap**
 ```
  Пуассоновский бутстреп для сравнения CTR между двумя группами
    Parameters:  
    likes1, views1: массивы лайков и просмотров для группы 1
    likes2, views2: массивы лайков и просмотров для группы 2  
    n_bootstrap: количество бутстреп-итераций (по умолчанию 2000)
   ``` 
  
```    
def bootstrap(likes1, views1, likes2, views2, n_bootstrap=2000):

    # Генерируем пуассоновские веса для бутстрепа первой группы
    # Каждая итерация бутстрепа имеет свои случайные веса для каждого пользователя
    poisson_bootstraps1 = stats.poisson(1).rvs(
        (n_bootstrap, len(likes1))).astype(np.int64)

    # Генерируем пуассоновские веса для бутстрепа первой группы
    poisson_bootstraps2 = stats.poisson(1).rvs(
            (n_bootstrap, len(likes2))).astype(np.int64)

    # Вычисляем CTR для каждой бутстреп-итерации первой группы
    # Умножаем лайки и просмотры на пуассоновские веса и суммируем
    globalCTR1 = (poisson_bootstraps1*likes1).sum(axis=1)/(poisson_bootstraps1*views1).sum(axis=1)

    # Вычисляем CTR для каждой бутстреп-итерации первой группы
    globalCTR2 = (poisson_bootstraps2*likes2).sum(axis=1)/(poisson_bootstraps2*views2).sum(axis=1)

    # Бутстреп-распределения CTR для обеих групп
    return globalCTR1, globalCTR2
```

  **Графики**
 
   - **Распределение массивов глобыльных CTR по группам**

![Распределение CTR метод Бутстреп](https://github.com/Alexa-grab/screenshots--for--projects./blob/main/%D1%80%D0%B0%D1%81%D0%BF%D1%80%D0%B5%D0%B4%D0%B5%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%B3%D0%BB%D0%BE%D0%B1%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D1%85%20%D1%81%D1%82%D1%80%20%D0%BC%D0%B5%D1%82%D0%BE%D0%B4%20%D0%91%D1%83%D1%82%D1%81%D1%82%D1%80%D0%B5%D0%BF.png)

   - **Разница массивов CTR**

![Разница массивов CTR Бутстреп](https://github.com/Alexa-grab/screenshots--for--projects./blob/main/%D0%A0%D0%B0%D0%B7%D0%BD%D0%B8%D1%86%D0%B0%20%D0%BC%D0%B0%D1%81%D1%81%D0%B8%D0%B2%D0%BE%D0%B2%20CTR%20%D0%91%D1%83%D1%82%D1%81%D1%82%D1%80%D0%B5%D0%BF.png)

#### Вывод  по приминению по метода Бутстреп

- Метод учитывает всю форму распределения;
- Получили массив данных с разницей бакетных CTR 2 и 1 группы;
- При построении 95% доверительного интервала использовали границы:
    - нижняя =2.5 перцентиль;
    - верхняя= 97.5 перцентиль.
- 95% ДИ: **[-0.0124, -0.0064]**;
- Весь доверительный интервал оказался в отрицательной зоне.

 **Эксперимент не успешен: CTR контрольной (1 группы) показывает лучшие результаты, чем у 2 группы (тестовой)**

### 5. Сглаженный CTR

 **Код для создания функции  вычисления сглаженного CTR**
 
 ```
 Вычисляет сглаженный CTR с использованием байесовского сглаживания
    
    Parameters:
    user_likes: количество лайков пользователя
    user_views: количество просмотров пользователя  
    global_ctr: глобальный CTR (по всем пользователям)
    alpha: параметр сглаживания, alpha=5 (чем больше alpha, тем больше сглаживание)
 ```
 ```
def get_smothed_ctr(user_likes, user_views, global_ctr, alpha):

    # Формула байесовского сглаживания:
    # Добавляем "виртуальные" наблюдения к реальным данным пользователя
    smothed_ctr = (user_likes + alpha * global_ctr) / (user_views + alpha)

    # Сглаженное значение CTR пользователя
    return smothed_ctr
```
 **Графики при применению метода сглаженного CTR**
 
- **Сглаженный CTR (1 группа)**
![Сглаженный CTR 1 группа](https://github.com/Alexa-grab/screenshots--for--projects./blob/main/%D0%A1%D0%B3%D0%BB%D0%B0%D0%B6%D0%B5%D0%BD%D0%BD%D1%8B%D0%B9%20CTR%201%20%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D0%B0.png)

- **Сглаженный CTR (2 группа)**
![Сглаженный CTR 2 группа](https://github.com/Alexa-grab/screenshots--for--projects./blob/main/%D0%A1%D0%B3%D0%BB%D0%B0%D0%B6%D0%B5%D0%BD%D0%BD%D1%8B%D0%B9%20CTR%202%20%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D0%B0.png)

#### Вывод по применению метода сглаженного CTR
  
 Результат Т-теста на сглаженных CTR:
  - **t_stat** = 1.9460491517027683
  - **p_val** = 0.05166679015318526

 **Различия между группами статистически незначимы**
 
 ### 6. Метод бакетного преобразования

  - **SQL Запрос к БД**
 
 ```
 # Разделение каждой группы на 50 бакетов и расчет бакетного CTR для каждой
 q = """
 SELECT exp_group, bucket,
    sum(likes)/sum(views) as bucket_ctr
 FROM (SELECT exp_group, 
        xxHash64(user_id)%50 as bucket,
        user_id,
        sum(action = 'like') as likes,
        sum(action = 'view') as views,
        likes/views as ctr
    FROM {db}.feed_actions 
    WHERE toDate(time) between '2025-08-02' and '2025-08-08' 
        and exp_group in (2,1)
    GROUP BY exp_group, bucket, user_id)
 GROUP BY exp_group, bucket
 """
 ```

![Распределение по бакетам](https://github.com/Alexa-grab/screenshots--for--projects./blob/main/%D1%80%D0%B0%D1%81%D0%BF%D1%80%D0%B5%D0%B4%D0%B5%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%BF%D0%BE%20%D0%B1%D0%B0%D0%BA%D0%B5%D1%82%D0%B0%D0%BC.png)

 #### Вывод по применению метода бакетного преобразования
   
  - **Результат Т-теста на бакетных CTR**
  
    - **t_stat** = 5.614819358149381
    - **p_val** = 4.592644937473873e-07
   
  - **Результат теста Манна-Уитни на бакетных CTR**

    - **y_stat** = 1997.0
    - **y_pval** = 2.6576427804010095e-07
      
 Агрегация по бакетам повысила чувствительность тестов и подтвердила наличие значимых различий между группами.  
   
 **Различия есть, нулевая гипотеза не верна**


### 7. Квантильный анализ

 - **Взяли для анализа:**
   - 0.1 квантиль;
   - 0.5-й  (медиана);
   - 0.9-кванитль;
   - 0.95 квантиль;
   - Среднее значение.
  
 ### 7.1. Групповые показатели CTR по квантилям
      
   - **SQL запрос к базе данных**
```
q = """
SELECT 
    exp_group,
    quantileExact(0.1)(ctr) as ctr_10,  -- 10-й перцентиль
    quantileExact(0.5)(ctr) as ctr_50,  -- медиана
    quantileExact(0.9)(ctr) as ctr_90,  -- 90-й перцентиль (уже есть у вас)
    quantileExact(0.95)(ctr) as ctr_95, -- 95-й перцентиль
    avg(ctr) as mean_ctr                -- среднее для сравнения
FROM (
    SELECT 
        exp_group, 
        xxHash64(user_id)%50 as bucket,
        user_id,
        sum(action = 'like') as likes,
        sum(action = 'view') as views,
        likes/views as ctr
    FROM {db}.feed_actions 
    WHERE toDate(time) between '2025-08-02' and '2025-08-08' 
        and exp_group in (2,1)
    GROUP BY exp_group, bucket, user_id
)
GROUP BY exp_group
"""
```

![CTR по квантилям](https://github.com/Alexa-grab/screenshots--for--projects./blob/main/CTR%20%D0%BF%D0%BE%20%D0%BA%D0%B2%D0%B0%D0%BD%D1%82%D0%B8%D0%BB%D1%8F%D0%BC.png)

 #### Выводы 
    
   Алгоритм рекомендаций улучшил CTR у 10% и ухудшил у 90%.
    
### 7.2. Анализ групп по 50 процентилю  (0.5 квантиль)
  
   - **SQL запрос к базе данных**
   
   ```
   # Группируем по группам и бакетам для проведения статистических тестов
   q = """
   SELECT 
    exp_group,bucket,
    quantileExact(0.1)(ctr) as ctr_10,  -- 10-й перцентиль
    quantileExact(0.5)(ctr) as ctr_50,  -- медиана
    quantileExact(0.9)(ctr) as ctr_90,  -- 90-й перцентиль (уже есть у вас)
    quantileExact(0.95)(ctr) as ctr_95, -- 95-й перцентиль
    avg(ctr) as mean_ctr                -- среднее для сравнения
   FROM (
    SELECT 
        exp_group, 
        xxHash64(user_id)%50 as bucket,
        user_id,
        sum(action = 'like') as likes,
        sum(action = 'view') as views,
        likes/views as ctr
    FROM {db}.feed_actions 
    WHERE toDate(time) between '2025-08-02' and '2025-08-08' 
        and exp_group in (2,1)
    GROUP BY exp_group, bucket, user_id
   )
   GROUP BY exp_group,bucket
   """
   ```
    
 -  **Медианные значения CTR по 0.5 квантилю**
     
    - **1 группа** = 0.1538461538461538;
    - **2 группа** = 0.2049737411183194;
    - **Разница медиан** = -0.0511.

         
   - **Гистограмма распределения 50 перцентиля (медианы) CTR по группам.**

 ![Медианный CTR по группам](https://github.com/Alexa-grab/screenshots--for--projects./blob/main/%D0%BC%D0%B5%D0%B4%D0%B8%D0%B0%D0%BD%D0%BD%D1%8B%D0%B9%20CTR%2050%20%D0%BA%D0%B2%D0%B0%D0%BD%D1%82%D0%B8%D0%BB%D1%8F%20%D0%BF%D0%BE%20%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D0%B0%D0%BC.png)

#### Выводы
   
  - Медианные CTR бакетов показывают устойчивое смещение: группа 2 имеет более низкие значения (~0.20-0.22);
  - Максимальное расхождение: всего 0.05; 
  - Нет выбросов.
  
### 7.3. Анализ групп по 90 процентилю  (0.9 квантиль)
     
   - **Гистограмма распределения по 90 перцентилю**

![90 процентиль CTR по группам](https://github.com/Alexa-grab/screenshots--for--projects./blob/main/90%20%D0%BF%D1%80%D0%BE%D1%86%D0%B5%D0%BD%D1%82%D0%B8%D0%BB%D1%8C%20CTR%20%D0%BF%D0%BE%20%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D0%B0%D0%BC.png)

 #### Выводы
   
  - Смещение вправо у 2 группы (тестовой);
  - Разница между пиками:  0.08 ;
  - Группа 2 имеет более высокие значения 90-го перцентиля;
  - В группе 2 топ-10% пользователей имеют более высокий CTR;
  - В группе 1 граница для топ-10% пользователей ниже.

### 8. Т-тест и Тест Манна-Уитни по 0.9 квантилю (90-й перцентиль)

  - **Результат прведения Т-теста:**
      
    -  **t_stat** = -22.821214612754606;
    - **p_val** = 4.17295352116894e-38.

  - **Результат проведения теста Манна-Уитни:**
    
    - **y_stat** = 0.0
    - **y_pval** = 6.7601631082665925e-18

  #### Выводы:
  
   - Т-Тест и Тест Манна -Уитни по 90 квантилю на бакетном преобразовании показал, что различия есть,можно отвергнуть нулевую гипотезу.
    
   - Улучшился результат для 10% пользователей, но это не повлияло на большинство пользователей.

### Сравнение результатов теста

| Метод | p-value | Стат. значимость | Интерпретация |
|-------|---------|------------------|---------------|
| **T-тест на первичных данных** | 0.685 | Не значимо | Чувствителен к среднему, где разница минимальна |
| **Тест Манна-Уитни на первичных данных** | 4.63e-45 | Значимо | Обнаружил разницу в форме распределений |
| **Пуассоновский бутстреп** | ДИ: [-0.0124, -0.0064] | Значимо | Весь ДИ ниже нуля - CTR группы 2(тестовой) хуже |
| **T-тест (сглаженный CTR)** | 0.052 |  Не значимо | На грани значимости, но не достигает α=0.05 |
|**T-тест (бакеты)**| 4.59e-07	| Значимо	| Агрегация выявила устойчивые различия |
|**Манн-Уитни (бакеты)**	| 2.66e-07	| Значимо	| Подтверждает различия на бакетизированных данных |
|**T-тест (90-й перцентиль)**|	4.17e-38 | Значимо	| Среднее значение верхних 10% разное |
|**Тест Манна-Уитни (90-й перцентиль)**| 6.76e-18 | Значимо | Распределение верхних 10% разное |
 

## Ключевые находки
 
 ### Распределение CTR

   - Группа 1 (контроль): Более компактное распределение;
   - Группа 2 (тест): Длинный правый хвост - немного пользователей с очень высоким CTR.

  ### Сегментный анализ

   - 90% пользователей: CTR ухудшился;   
   - 10% пользователей (топ): CTR значительно улучшился;   
   -  Медианный CTR: 0.154 (гр.1) vs 0.205 (гр.2) - улучшение на 33%.

  ### Объяснение расхождений между тестами

   - **T-тест на исходных данных не показал значимости из-за:**

        - Минимальной разницы в средних (-0.00067);
        - Противоположных эффектов у разных сегментов.

   - **Тест Манна-Уитни показал значимость, так как чувствителен к:**

        - Разной форме распределений;
        - Сдвигу в верхних квантилях.
          
   - **Пуассоновский бутстреп показал значимость:**

       - Учитывает всю форму распределения, а не только средние;
       - Весь 95% доверительный интервал разницы CTR находится в отрицательной области;
       - Подтверждает стабильное ухудшение CTR в тестовой группе.

   - **Бакетные тесты оказались наиболее мощными благодаря:**

       - Снижению шума за счет агрегации;
       - Более нормальному распределению CTR бакетов.

 ### Потенциальный сценарий
  
  - **Новый алгоритм, вероятно, использует более агрессивную персонализацию, которая:**

      - Идеально работает для небольшой когорты пользователей с четкими предпочтениями;

      - Ухудшает опыт для большинства, предлагая слишком нишевый или повторяющийся контент.

 ### Рекомендация
    
  **НЕ РАСКАТЫВАТЬ на всех новых пользователей.**

  - **Обоснование:**

    - Негативный общий эффект - 90% пользователей получают худший опыт;

    - Риск оттока - ухудшение ключевой метрики у большинства аудитории;

    - Нестабильность - алгоритм работает непредсказуемо для разных сегментов;

  - **Дальнейшие действия**

    - Сегментный анализ: Выявить характеристики "топ-10%" пользователей;

    - Качественное исследование: Понять причины ухудшения UX у большинства;

    - Итеративная доработка: Настроить алгоритм для баланса между персонализацией и разнообразием;

    - Сегментированный A/B тест: Протестировать доработанную версию на целевых группах.

## Заключение
  
 - Новый алгоритм демонстрирует потенциал для глубокой персонализации, но требует значительной доработки перед промышленным внедрением.
   
 - Текущая версия непригодна для массовой раскатки из-за негативного воздействия на большинство пользователей.
