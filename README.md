#### Учебный проект

от Karpov.Courses [Karpov.Courses](https://karpov.courses/simulator)

# Анализ A/B теста нового алгоритма рекомендации постов

## Цель проекта  

 Оценить эффективность нового алгоритма рекомендации постов, проверив гипотезу о его положительном влиянии на **CTR (Click-Through Rate)** в ходе A/B-теста, и принять взвешенное решение о его запуске для всех новых пользователей.

## Задачи  

 - Провести первичный анализ данных: загрузить данные, проверить их целостность и корректность разделения на группы.
 - Исследовать распределения: визуально и статистически оценить распределение показов, кликов и CTR в обеих группах.
 - Применить комплекс статистических тестов:
   - t-тест на сырых данных
   - Пуассоновский бутстреп
   - Тест Манна-Уитни
   - t-тест на сглаженном CTR (с α=5)
    - t-тест и тест Манна-Уитни на данных, агрегированных по бакетам.

  - Интерпретировать результаты: объяснить возможные расхождения между результатами разных тестов, опираясь на природу данных.

  - Сформулировать вывод и рекомендацию: на основе совокупности доказательств дать обоснованную рекомендацию о раскатке нового алгоритма.

## Инструменты

  - **База данных**: ClickHouse  
  - **Язык программирования:** Python
  - **Основные библиотеки:** pandas, numpy, scipy, statsmodels, matplotlib/seaborn
  - **Методы:** Статистическое тестирование, бутстреп, визуализация данных
  
## Источники информации  

  - База данных в ClickHouse.

#### Структура таблиц БД

**1. Feed_actions**
 - **post_id:** id поста;
 - **user_id:** id пользователя;
 - **action:** совершенное действие view/like;
 - **time:** время совершенного действия;
 - **gender/city/country/os/source:** информация о пользователе;
 - **exp_group:** номер эксперементальной группы.

**2. Message_actions**
- **user_id:** id отправителя сообщения;
- **receiver_id:** id получателя сообщения;
- **time:** время совершенного действия;
- **gender/city/country/os/source:** информация о пользователе.

## Структура проекта
-
-
## Вводные данные А/Б теста

 **1. Данные для теста**  
 
  - Эксперимент проходил с 2025-08-02 по 2025-08-08 включительно;
  - Для эксперимента были задействованы 2 и 1 группы;
  - В группе 2 был использован один из новых алгоритмов рекомендации постов.
 
**2. Группы:**

 - **1 группа** - контрольная(без изменений);
 - **2 группа** - тестовая (был использован один из новых алгоритмов рекомендации постов)/

 **3. Основная метрика:**

  - CTR 

**4. Гипотезы**

- **Нулевая гипотеза:** Новый алгоритм не приведет к увелечению CTR во 2ой группе.
- **Альтернативная гипотеза:** Новый алгоритм во 2-й группе приведет к увеличению CTR. 

## Этапы решения

### 1.Распределение по группам.

 ** 1.1.Количество участников**
 
![Распределение по группам](https://github.com/Alexa-grab/screenshots--for--projects./blob/main/%D0%A0%D0%B0%D1%81%D0%BF%D1%80%D0%B5%D0%B4%D0%B5%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%BF%D0%BE%20%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D0%B0%D0%BC.png)

 **Вывод**
 
  - Количество участников распределно равномерно;
  - В каждой группе ~ 10000 человек.
 
  **1.2.Анализ равномерности распределения и значения метрики CTR**
 
![Распределение CTR для группы 1 и 2](https://github.com/Alexa-grab/screenshots--for--projects./blob/main/%D1%80%D0%B0%D1%81%D0%BF%D1%80%D0%B5%D0%B4%D0%B5%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20CTR%20%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D1%8B%201%20%D0%B8%202.png)

 **Вывод**

  - **Гистограммы распределения CTR**
    
    - В 2 группе(тестовой) , правый хвост длиннее, чем в 1 группе.
    - Большинство значений во 2 группе < значений 1 группы.
     
  Распределения CTR в группах имеют разную форму: во второй группе присутствует длинный правый хвост при том, что основная масса значений ниже, чем в первой.

- **Среднее значение CTR в группах**
  
   - AVG CTR гр.1 =0.216773994120072
   - AVG CTR гр.2 =0.2161016893237817
   - Разница diff= -0.0006723047962902962
     
 **CTR 1 группы (контрольной) > CTR 2 группы (тестовой)**

### 2.Проведение Т-теста

**Вывод**

 - **t_stat** = 0.4051491913112757;
 - **p_val** = 0.685373331140751;
 - Т-тест менее чувствителен к данным, т.к. разница между средними группами очень маленькая (в абсолютном значении -0.00067).
   
**Различия между группами статистически незначимы.**

### 3. Тест Манна-Уитни

**Вывод**

 - **y_stat** = 55189913.00 
 - **y_pval** = 4.632205841806026e-45
 - Тест показал значимые отличия, т.к. он  чувствителен к форме распределения (во 2-й группе длинный правый хвост,
что  создает разницу в распределениях)

**Различия есть, нулевая гипотеза не верна**

### 4. Метод Пуассоновский бутстреп

 **Код для создании функции bootstrap**
```
def bootstrap(likes1, views1, likes2, views2, n_bootstrap=2000):

    poisson_bootstraps1 = stats.poisson(1).rvs(
        (n_bootstrap, len(likes1))).astype(np.int64)

    poisson_bootstraps2 = stats.poisson(1).rvs(
            (n_bootstrap, len(likes2))).astype(np.int64)
    
    globalCTR1 = (poisson_bootstraps1*likes1).sum(axis=1)/(poisson_bootstraps1*views1).sum(axis=1)
    
    globalCTR2 = (poisson_bootstraps2*likes2).sum(axis=1)/(poisson_bootstraps2*views2).sum(axis=1)

    return globalCTR1, globalCTR2
```

  **Графики при применнении метода Бутстреп**
 
   - **Распределение массивов глобыльных CTR по группам**

![Распределение CTR метод Бутстреп](https://github.com/Alexa-grab/screenshots--for--projects./blob/main/%D1%80%D0%B0%D1%81%D0%BF%D1%80%D0%B5%D0%B4%D0%B5%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%B3%D0%BB%D0%BE%D0%B1%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D1%85%20%D1%81%D1%82%D1%80%20%D0%BC%D0%B5%D1%82%D0%BE%D0%B4%20%D0%91%D1%83%D1%82%D1%81%D1%82%D1%80%D0%B5%D0%BF.png)

   - **Разница массивов CTR**

![Разница массивов CTR Бутстреп](https://github.com/Alexa-grab/screenshots--for--projects./blob/main/%D0%A0%D0%B0%D0%B7%D0%BD%D0%B8%D1%86%D0%B0%20%D0%BC%D0%B0%D1%81%D1%81%D0%B8%D0%B2%D0%BE%D0%B2%20CTR%20%D0%91%D1%83%D1%82%D1%81%D1%82%D1%80%D0%B5%D0%BF.png)

#### Вывод  по приминению по методу Бутстреп

- Метод учитывает всю форму распределения;
- Получили массив данных с разницей бакетных CTR 2 и 1 группы;
- При построении 95% доверительного интервала использовали границы:
    - нижняя =2.5 перцентиль;
    - верхняя= 97.5 перцентиль.
- 95% ДИ: [-0.0124, -0.0064];
- Верхняя граница данных < 0;
- Весь доверительный интервал оказался в отрицательной зоне.

 **Эксперимент не успешен: CTR контрольной (1 группы) показывает лучшие результаты, чем у 2 группы (тестовой)**

### 5.Сглаженный CTR

 **Код для создания функции  вычисления сглаженного CTR**
 
 ```
def get_smothed_ctr(user_likes, user_views, global_ctr, alpha):
    smothed_ctr = (user_likes + alpha * global_ctr) / (user_views + alpha)
    return smothed_ctr
```
 **Графики при применению метода сглаженного CTR**
Сглаженный CTR 1 группа
![Сглаженный CTR 1 группа](https://github.com/Alexa-grab/screenshots--for--projects./blob/main/%D0%A1%D0%B3%D0%BB%D0%B0%D0%B6%D0%B5%D0%BD%D0%BD%D1%8B%D0%B9%20CTR%201%20%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D0%B0.png)

Сглаженный CTR 2 группа
![Сглаженный CTR 2 группа](https://github.com/Alexa-grab/screenshots--for--projects./blob/main/%D0%A1%D0%B3%D0%BB%D0%B0%D0%B6%D0%B5%D0%BD%D0%BD%D1%8B%D0%B9%20CTR%202%20%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D0%B0.png)

#### Вывод по применению метода сглаженного CTR
  
 Результат т-теста на сглаженных CTR:
  - **t_stat** = 1.9460491517027683
  - **p_val** = 0.05166679015318526

 **Различия между группами статистически незначимы**
 
 ### 6. Метод бакетного преобразования

  - **SQL Запрос к БД**
 
 ```
 -- Разделение каждой группы на 50 бакетов и расчет бакетного CTR для каждой
 q = """
 SELECT exp_group, bucket,
    sum(likes)/sum(views) as bucket_ctr
 FROM (SELECT exp_group, 
        xxHash64(user_id)%50 as bucket,
        user_id,
        sum(action = 'like') as likes,
        sum(action = 'view') as views,
        likes/views as ctr
    FROM {db}.feed_actions 
    WHERE toDate(time) between '2025-08-02' and '2025-08-08' 
        and exp_group in (2,1)
    GROUP BY exp_group, bucket, user_id)
 GROUP BY exp_group, bucket
 """
 ```

 - **Графики при применении метода бакетного преобразования**

![Распределение по бакетам](https://github.com/Alexa-grab/screenshots--for--projects./blob/main/%D1%80%D0%B0%D1%81%D0%BF%D1%80%D0%B5%D0%B4%D0%B5%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%BF%D0%BE%20%D0%B1%D0%B0%D0%BA%D0%B5%D1%82%D0%B0%D0%BC.png)

 #### Вывод по применению метода бакетного преобразования
   
 **Агрегация по бакетам повысила чувствительность тестов и подтвердила наличие значимых различий между группами.**

   -**Результат Т-теста на бакетных CTR**
  
   - **t_stat** = 5.614819358149381
   - **p_val** = 4.592644937473873e-07
   
**Различия есть, нулевая гипотеза не верна.**

 -**Результат теста Манна-Уитни на бакетных CTR**

   - **y_stat** = 1997.0
   - **y_pval** = 2.6576427804010095e-07
  
**Различия есть, нулевая гипотеза не верна**

### 7. Анализ по квантилям

- Взяли для анализа:
  - 0.1 квантиль;
  - 0.5-й  (медиана);
  - 0.9-кванитль;
  - 0.95 квантиль;
  - среднее значение.

  **7.1. Групповые показатели CTR по квантилям**
  
  - **SQL запрос к базе данных**
```
q = """
SELECT 
    exp_group,
    quantileExact(0.1)(ctr) as ctr_10,  -- 10-й перцентиль
    quantileExact(0.5)(ctr) as ctr_50,  -- медиана
    quantileExact(0.9)(ctr) as ctr_90,  -- 90-й перцентиль (уже есть у вас)
    quantileExact(0.95)(ctr) as ctr_95, -- 95-й перцентиль
    avg(ctr) as mean_ctr                -- среднее для сравнения
FROM (
    SELECT 
        exp_group, 
        xxHash64(user_id)%50 as bucket,
        user_id,
        sum(action = 'like') as likes,
        sum(action = 'view') as views,
        likes/views as ctr
    FROM {db}.feed_actions 
    WHERE toDate(time) between '2025-08-02' and '2025-08-08' 
        and exp_group in (2,1)
    GROUP BY exp_group, bucket, user_id
)
GROUP BY exp_group
"""
```

![CTR по квантилям](https://github.com/Alexa-grab/screenshots--for--projects./blob/main/CTR%20%D0%BF%D0%BE%20%D0%BA%D0%B2%D0%B0%D0%BD%D1%82%D0%B8%D0%BB%D1%8F%D0%BC.png)

 #### Вывод 
  
 По групповым показателям по квантилям видно, что  алгоритм рекомендаций улучшил CTR у 10% и ухудшил у 90%.

 - **7.2.Анализ групповых показателей квантилей по бакетам.**

   - **Анализ групп по 50 процентилю  (0.5 квантиль)** 

    - **SQL запрос к базе данных**
   ```
   -- Группируем по группам и бакетам для проведения статистических тестов
   q = """
   SELECT 
    exp_group,bucket,
    quantileExact(0.1)(ctr) as ctr_10,  -- 10-й перцентиль
    quantileExact(0.5)(ctr) as ctr_50,  -- медиана
    quantileExact(0.9)(ctr) as ctr_90,  -- 90-й перцентиль (уже есть у вас)
    quantileExact(0.95)(ctr) as ctr_95, -- 95-й перцентиль
    avg(ctr) as mean_ctr                -- среднее для сравнения
   FROM (
    SELECT 
        exp_group, 
        xxHash64(user_id)%50 as bucket,
        user_id,
        sum(action = 'like') as likes,
        sum(action = 'view') as views,
        likes/views as ctr
    FROM {db}.feed_actions 
    WHERE toDate(time) between '2025-08-02' and '2025-08-08' 
        and exp_group in (2,1)
    GROUP BY exp_group, bucket, user_id
   )
   GROUP BY exp_group,bucket
   """
   ```
    
 - **Медианные значения по 0.5 квантилю**
     
  - **1 группа** = 0.1538461538461538;
  - **2 группа** = 0.2049737411183194;
  - **Разница медиан** = -0.0511.

       
 - **Гистограмма распределения 50 перцентиля (медианы) CTR по группам.**

 ![Медианный CTR по группам](https://github.com/Alexa-grab/screenshots--for--projects./blob/main/%D0%BC%D0%B5%D0%B4%D0%B8%D0%B0%D0%BD%D0%BD%D1%8B%D0%B9%20CTR%2050%20%D0%BA%D0%B2%D0%B0%D0%BD%D1%82%D0%B8%D0%BB%D1%8F%20%D0%BF%D0%BE%20%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D0%B0%D0%BC.png)

 - **Вывод**
   
  - Медианные CTR бакетов показывают устойчивое смещение: группа 2 имеет более низкие значения (~0.20-0.22);
  - Максимальное расхождение: всего 0.05; 
  - Нет выбросов.

 -  **Анализ групп по 90 процентилю  (0.9 квантиль)**
     
  - **Гистограмма распределения по 90 перцентилю**

![90 процентиль CTR по группам](https://github.com/Alexa-grab/screenshots--for--projects./blob/main/90%20%D0%BF%D1%80%D0%BE%D1%86%D0%B5%D0%BD%D1%82%D0%B8%D0%BB%D1%8C%20CTR%20%D0%BF%D0%BE%20%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D0%B0%D0%BC.png)

 - **Вывод**
   
  - Смещение вправо у 2 группы (тестовой);
  - Разница между пиками:  0.08 ;
  - Группа 2 имеет более высокие значения 90-го перцентиля;
  - В группе 2 топ-10% пользователей имеют более высокий CTR;
  - В группе 1 граница для топ-10% пользователей ниже.

### 8.Т-тест и Тест Манна-Уитни по 90 квантилю

  - **Результат прведения Т-теста:**
      
    -  **t_stat** = -22.821214612754606;
    - **p_val** = 4.17295352116894e-38.

  - **Результат прведения теста Манна-Уитни:**
    
    - **y_stat** = 0.0
    - **y_pval** = 6.7601631082665925e-18
  
  Т-Тест и Тест Манна -Уитни по 90 квантилю на бакетном преобразовании показал, что различия есть,можно отвергнуть нулевую гипотезу.  
  Улучшился результат для 10% пользователей, но это не повлияло на большинство пользователей.

 
## Результат эксперимента:

 **Предложенное изменение в алгоритме нестабильно. Оно значительно улучшило показатель CTR у 10% пользователей (топовый сегмент), но заметно ухудшило его у остальных 90%. В среднем эффект близок к нулю из-за разнонаправленного воздействия на разные сегменты аудитории.**

 **Рекомендации:**

  - Изменение нельзя выпускать на всю аудиторию, так как оно ухудшает опыт для большинства пользователей. 

 **Возможные варианты решения:**

  - Сегментировать анализ: Определить, кем являются те 10% пользователей, которым изменение помогло (новые/старые, демография, поведение).
  - Провести исследование с пользователями из разных сегментов и провести A/B тестирование для разных групп отдельно.
  - Постепенно внедрять изменения, а не делать резкий переход.
  - Доработать алгоритм: Попытаться понять, какой механизм в изменении вызывает ухудшение у большинства, и устранить его.

 **Почему это могло произойти:**

  - Модель неправильно определяет интересы пользователя.
  - Алгоритм плохо работает для новых пользователей, у которых мало данных о поведении.
  - Не учитывается время суток, день недели, местоположение пользователя.
  - Алгоритм рекомендует только самое популярное, без персонализации.
  - Рекомендации появляются слишком часто, мешая органическому контенту.
  - Изменилось расположение постов и интерфейс и пользователи не понимают, по какому принципу теперь строится лента.
  - Алгоритм слишком агрессивно продвигает платный или рекламный контент.
  - Технические ошибки в работе рекомендательной системы.
 
